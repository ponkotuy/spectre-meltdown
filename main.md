# Meltdown/Spectre

---

## 発表内容
当該脆弱性はCPU高速化技法に起因するので

CPUの仕組みの解説から

CPU高速化の技法を解説して

MeltdownとSpectreの問題を軽く解説

---

### CPUの命令
CPU命令はプログラム実行の最小単位

演算命令やメモリ読込命令とか

コンパイルはCPU命令に変更する作業

実行命令の数をステップ数とか

可視化したものがアセンブラ

---

### パイプライン
命令の実行はABCDに分けられるとする

CPUにはABCDを処理するハードウェア

ある命令のA実行が終われば次のA実行ができる

ステージ段数を更に増やせば高速化できる

---

### パイプラインストール
パイプラインに命令を充填できないことがある

これをパイプラインストールという

- 前の命令結果に依存する命令(データハザード
  - 特にメモリ読み込みに依存する場合
- ハードウェア不足(構造ハザード
- 分岐命令がある場合(制御ハザード

当然パイプラインストールすると性能が低下する

---

## アウトオブオーダー実行
CPU命令は原則逐次実行である

命令によっては先に実行することが可能

ストールを避けるために以降の命令を充填

---

### 分岐予測・投機実行
分岐命令は終わるまでパイプラインストールを起こす

分岐を仮定して処理を続行する→投機実行

成功すれば処理が高速化できる

失敗した場合結果をflushして再実行する

(失敗が多い場合却って高コストになる

---

### 事例：Pentium 4 Presscot
CPUの周波数=性能と思われていた時代

命令実行を30ステージに分割、高周波数へ

→周波数が高く消費電力が高いのに低性能

原因
- リーク電流増加(半導体による
- 消費電力増加
- 分岐予測失敗時のコスト増加

---

## Spectre脆弱性
分岐予測投機実行に起因する脆弱性

ほぼ全ての分岐予測可能なCPUに存在

+ 権限で読めないメモリの読込を分岐予測させるコードの実行
+ CPUは投機実行してキャッシュに置く
+ 権限が無いので実行そのものはキャンセルされる
+ キャッシュの変更を追跡してデータを読む

※キャッシュは共有されていて権限が無い

---

## Meltdown脆弱性
アウトオブオーダーに起因する脆弱性
IntelとARMの一部CPUに存在

+ 権限で読めないメモリの読込命令を発行
+ ↑OoOが働いて次の命令を実行
+ 次の命令で先の結果に依存したメモリ読み込み
+ 権限エラーが発覚、全ての結果をflush
+ キャッシュの変更を追跡してデータを読む

---

## まとめると
+ 権限違反の命令を発行
+ 投機実行でそれに依存した次の命令を発行させる
+ 違反が発覚し、実行がキャンセルされるがキャッシュ変更は残る
+ キャッシュ変更からデータを推測可能

---

## 対策について
CPUの脆弱性であり、抜本的には次期アーキテクチャ待ち

対処療法は可能で各OS・ソフトウェアから出ている

最新版にアップデートしろ
